<contract archiveOpt="P1Y" archiveReq="P1Y" canActAsTemplate="true" duration="P99Y" id="PaylinkToken" visibility="Public" xmlns="urn:ieee:iot:leg:sc:1.0">
	<Create xmlns="https://paiwise.tagroot.io/Schema/NeuroFeatures.xsd">
		<TokenID shortIdAlphabet="0123456789" shortIdLength="10">
			<Random />
		</TokenID>
		<Creator>
			<RoleReference role="Creator" />
		</Creator>
		<Owner>
			<RoleReference role="Creator" />
		</Owner>
		<TrustProvider>
			<RoleReference role="TrustProvider" />
		</TrustProvider>
		<Value>
			<ParameterReference parameter="Value" />
		</Value>
		<Currency>
			<ParameterReference parameter="Currency" />
		</Currency>
		<CommissionPercent>
			<ParameterReference parameter="CommissionPercent" />
		</CommissionPercent>
		<Expires>
			<ParameterReference parameter="Expires" />
		</Expires>
		<CreatorCanDestroy>
			<Boolean>true</Boolean>
		</CreatorCanDestroy>
		<OwnerCanDestroyIndividual>
			<Boolean>true</Boolean>
		</OwnerCanDestroyIndividual>
		<Definition>
			<StateMachine startState="AwaitingCardRegistration" xmlns="https://paiwise.tagroot.io/Schema/StateMachines.xsd">
				<Variable id="Title">
					<TagReference tag="Title" />
				</Variable>
				<Variable id="Description">
					<TagReference tag="Description" />
				</Variable>
				<Variable id="AmountToPay">
					<TagReference tag="AmountToPay" />
				</Variable>
				<Variable id="Price">
					<TagReference tag="Value" />
				</Variable>
				<Variable id="Currency">
					<TagReference tag="Currency" />
				</Variable>
				<Variable id="Country">
					<TagReference tag="Country" />
				</Variable>
				<Variable id="TokenContract">
					<TokenProperty>CreationContract</TokenProperty>
				</Variable>
				<Variable id="TokenId">
					<TokenProperty>TokenId</TokenProperty>
				</Variable>
				<Variable id="Buyer">
					<TagReference tag="Buyer" />
				</Variable>
				<Variable id="BuyerEmail">
					<TagReference tag="BuyerEmail" />
				</Variable>
				<Variable id="BuyerAddress">
					<TagReference tag="BuyerAddress" />
				</Variable>
				<Variable id="BuyerCity">
					<TagReference tag="BuyerCity" />
				</Variable>
				<Variable id="CallBackUrl">
					<TagReference tag="CallBackUrl" />
				</Variable>
				<Variable id="Seller">
					<TagReference tag="Seller" />
				</Variable>
				<Variable id="SellerName">
					<TagReference tag="SellerName" />
				</Variable>
				<Variable id="SellerBankAccount">
					<TagReference tag="SellerBankAccount" />
				</Variable>
				<Variable id="PaymentDeadline">
					<TagReference tag="PaymentDeadline" />
				</Variable>
				<Variable id="EscrowFee">
					<TagReference tag="EscrowFee" />
				</Variable>
				<Variable id="SMSCounter">
					<Number>0</Number>
				</Variable>
				<Variable id="EmailCounter">
					<Number>0</Number>
				</Variable>
				<Variable id="Notifications">
					<Calc><![CDATA[{}]]></Calc>
				</Variable>
				<Variable id="NeuronDomain">
					<Calc><![CDATA[Gateway.Domain]]></Calc>
				</Variable>
				<Variable id="BuyerPhoneNumber">
					<TagReference tag="BuyerPhoneNumber" />
				</Variable>
				<Variable id="RemoteId">
					<TagReference tag="RemoteId" />
				</Variable>
				<Variable id="ErrorUrl">
					<TagReference tag="ErrorUrl" />
				</Variable>
				<Variable id="SuccessUrl">
					<TagReference tag="SuccessUrl" />
				</Variable>
				<Variable id="CanCancel">
					<Boolean>false</Boolean>
				</Variable>
				<Variable id="TimeZoneOffset">
					<Number>0</Number>
				</Variable>
				<Variable id="CardRegistrationAmount">
					<Number>1</Number>
				</Variable>
				<Variable id="MaxFailedPaymentAttempts">
					<Number>5</Number>
				</Variable>
				<Variable id="FailedPaymentAttempts">
					<Number>0</Number>
				</Variable>
				<Variable id="TotalCompletedPayments">
					<Number>0</Number>
				</Variable>
				<Variable id="TotalNumberOfPayments">
					<TagReference tag="TotalNumberOfPayments" />
				</Variable>
				<Variable id="DayOfMonth">
					<TagReference tag="DayOfMonth" />
				</Variable>
				<Variable id="ActiveCardDetails">
					<Calc>{}</Calc>
				</Variable>
				<Variable id="DeliveryDate">
					<TagReference tag="DeliveryDate" />
				</Variable>
				<Variable id="CreatorJid">
					<TokenProperty>CreatorJid</TokenProperty>
				</Variable>
				<State id="AwaitingCardRegistration">
					<OnEnter actionRef="SetServiceProvider"/>
					<OnEvent actionRef="RegisterCard" newState="AwaitingNextPayment" failureState="AwaitingCardRegistration">
						<OnExternalXmlNote localName="PayspotPaymentCompleted" namespace="{'https://' + NeuronDomain + '/Downloads/EscrowPaylinkRS.xsd'}" noteVariable="Note" sourceVariable="Source"/>
					</OnEvent>
					<OnEvent actionRef="ProcessPayspotPaymentStatus" newState="AwaitingCardRegistration" failureState="AwaitingCardRegistration">
						<OnExternalXmlNote localName="PayspotPaymentStatus" namespace="{'https://' + NeuronDomain + '/Downloads/EscrowPaylinkRS.xsd'}" noteVariable="Note" sourceVariable="Source"/>
					</OnEvent>
					<OnEvent newState="PaymentNotPerformed">
						<OnDateTime>{PaymentDeadline}</OnDateTime>
					</OnEvent>
					<OnEvent newState="PaymentNotPerformed">
						<OnXmlNote localName="CancelPayment" namespace="{'https://' + NeuronDomain + '/Downloads/EscrowPaylinkRS.xsd'}" noteVariable="Note"/>
					</OnEvent>
					<OnEvent newState="PaymentNotPerformed">
						<OnExternalXmlNote localName="CancelPayment" namespace="{'https://' + NeuronDomain + '/Downloads/EscrowPaylinkRS.xsd'}" noteVariable="Note" sourceVariable="Source"/>
					</OnEvent>
					<OnEvent actionRef="SetBuyerTimeZoneDifference">
						<OnExternalXmlNote localName="BuyerTimeZoneDifference" namespace="{'https://' + NeuronDomain + '/Downloads/EscrowPaylinkRS.xsd'}" noteVariable="Note" sourceVariable="Source"/>
					</OnEvent>
					<OnEvent actionRef="UpdateBuyerInformations">
						<OnExternalXmlNote localName="UpdateBuyerInformations" namespace="{'https://' + NeuronDomain + '/Downloads/EscrowPaylinkRS.xsd'}" noteVariable="Note" sourceVariable="Source"/>
					</OnEvent>
				</State>

				<State id="AwaitingNextPayment">
					<OnEvent actionRef="TryToAuthorizeFunds" newState="PaymentCompleted" failureState="PaymentFailed">
						<OnDateTime>{DeliveryDate}</OnDateTime>
					</OnEvent>
					<OnEvent newState="PaymentCanceled" failureState="PaymentCanceled">
						<OnExternalXmlNote localName="CancelPayment" namespace="{'https://' + NeuronDomain + '/Downloads/EscrowPaylinkRS.xsd'}" noteVariable="Note" sourceVariable="Source"/>
					</OnEvent>
					<OnEvent newState="PaymentCanceled" failureState="PaymentCanceled">
						<OnXmlNote localName="CancelPayment" namespace="{'https://' + NeuronDomain + '/Downloads/EscrowPaylinkRS.xsd'}" noteVariable="Note"/>
					</OnEvent>
					<OnEvent actionRef="UpdateBuyerInformations">
						<OnExternalXmlNote localName="UpdateBuyerInformations" namespace="{'https://' + NeuronDomain + '/Downloads/EscrowPaylinkRS.xsd'}" noteVariable="Note" sourceVariable="Source"/>
					</OnEvent>
					<OnEvent actionRef="RegisterCard" newState="AwaitingNextPayment" failureState="AwaitingNextPayment">
						<OnExternalXmlNote localName="PayspotPaymentCompleted" namespace="{'https://' + NeuronDomain + '/Downloads/EscrowPaylinkRS.xsd'}" noteVariable="Note" sourceVariable="Source"/>
					</OnEvent>
				</State>

				<State id="PaymentCompleted">
					<OnEnter actionRef="IncrementTotalCompletedPayments"/>
					<OnEvent actionRef="ResetFailedAttemptsCounter">
						<OnDuration>PT1S</OnDuration>
					</OnEvent>
					<OnEvent actionRef="CalculateNextDeliveryDate" newState="AwaitingNextPayment">
						<OnDuration>PT2S</OnDuration>
					</OnEvent>
					<OnEvent newState="Done">
						<OnCondition>TotalCompletedPayments &gt;= TotalNumberOfPayments</OnCondition>
					</OnEvent>
				</State>

				<State id="PaymentCanceled">
					<OnEnter actionRef="MarkAsDone"/>
				</State>
				<State id="Done">
					<OnEnter actionRef="MarkAsDone"/>
				</State>

				<State id="PaymentFailed">
					<OnEnter actionRef="IncrementFailedAttemptsCounter"/>
					<OnEvent actionRef="CalculateNextAuthorizationRetryAttempt" newState="AwaitingNextPayment">
						<OnDuration>PT1S</OnDuration>
					</OnEvent>
					<OnEvent newState="PaymentCanceled">
						<OnCondition>FailedPaymentAttempts &gt;= MaxFailedPaymentAttempts</OnCondition>
					</OnEvent>
				</State>

				<State id="PaymentNotPerformed">
					<OnEnter actionRef="MarkAsDone"/>
				</State>

				<Action id="RegisterCard">
					<Script>
						Amount:= Num(SelectXmlStr(Note,'/default:PayspotPaymentCompleted/@amount'));
						OrderId:= SelectXmlStr(Note,'/default:PayspotPaymentCompleted/@orderId');
						PaymentType := SelectXmlStr(Note,'/default:PayspotPaymentCompleted/@paymentType');

						cardBrand:= SelectXmlStr(Note,'/default:PayspotPaymentCompleted/@cardBrand');
						panAlias:= SelectXmlStr(Note,'/default:PayspotPaymentCompleted/@panAlias');
						expiryDate:= SelectXmlStr(Note,'/default:PayspotPaymentCompleted/@expiryDate');
						maskedPan:= SelectXmlStr(Note,'/default:PayspotPaymentCompleted/@maskedPan');

						ActiveCardDetails.CardBrand:= cardBrand;
						ActiveCardDetails.PanAlias:= panAlias;
						ActiveCardDetails.ExpiryDate:= expiryDate;
						ActiveCardDetails.MaskedPan:= maskedPan;
						ActiveCardDetails.RegistrationOrderId:= OrderId;
						ActiveCardDetails.RegistrationAmount:= Amount;
						ActiveCardDetails.CardRegistrationDateTime:= NowUtc;
						ActiveCardDetails.IsValid:= false;
					</Script>
					<Try>
						<BuyEDaler to="{Seller}"
							   amount="{Amount}"
							   currency="{Currency}"
							   reference="{'nfeat: ' + TokenId}"
							   contract="{TokenContract}"
							   serviceId="{ServiceProviderId}"
							   serviceProvider="{ServiceProviderType}">
							<Parameter key="AmountToPay" value="{Amount}"></Parameter>
							<Parameter key="Currency" value="{Currency}"></Parameter>
							<Parameter key="OrderId" value="{ActiveCardDetails.RegistrationOrderId}"></Parameter>
							<Parameter key="ContractId" value="{TokenContract}"></Parameter>
						</BuyEDaler>

						<CallAction actionRef="RefundRegistrationAmount" />

						<If condition="!Evaluate('POWRS.PaymentLink.CardHelper.IsCardExpired(DeliveryDate, ActiveCardDetails.ExpiryDate)')">
							<Then>
								<Script>
									ActiveCardDetails.IsValid:= true;
								</Script>
								<PersistVariable name="PaymentType" value="{PaymentType}" />
								<PersistVariable name="ActiveCardDetails" value="{ActiveCardDetails}" />
							</Then>
							<Else>
								<Error reason="Payment completed but card is not valid long enough."></Error>
							</Else>
						</If>
						<Catch exceptionVariable="ex">
							<LogEvent type="Error" eventId="RegisterCard" actor="{Seller}" message="{ex.Message}"></LogEvent>
							<Error reason="{ex.Message}"></Error>
						</Catch>
					</Try>
				</Action>
				<Action id="ProcessPayspotPaymentStatus">
					<Script>
						OrderId:= SelectXmlStr(Note,'/default:PayspotPaymentStatus/@orderId');
						PaymentType := SelectXmlStr(Note,'/default:PayspotPaymentStatus/@paymentType');
						PaymentStatusCode := SelectXmlStr(Note,'/default:PayspotPaymentStatus/@paymentStatusCode');
						PaymentStatusDescr := SelectXmlStr(Note,'/default:PayspotPaymentStatus/@paymentStatusDescr');
						maskedPan:= SelectXmlStr(Note,'/default:PayspotPaymentStatus/@maskedPan');
						expiryDate:= SelectXmlStr(Note,'/default:PayspotPaymentStatus/@expiryDate');
						cardBrand:= SelectXmlStr(Note,'/default:PayspotPaymentStatus/@cardBrand');
						amount:= SelectXmlStr(Note,'/default:PayspotPaymentStatus/@amount');
					</Script>
					<Try>
						<LogEvent actor="{Seller}" eventId="PaymentStatus" level="Medium" message="{'ProcessPayspotPaymentStatus, paymentStatus: ' + PaymentStatusDescr, 'PaySpotStatusCode: ' + PaySpotStatusCode }" object="{Buyer}" type="Informational" />
						<Catch exceptionVariable="ex">
							<LogEvent type="Error" eventId="ProcessPayspotPaymentStatus" actor="{Seller}" message="{ex.Message}"></LogEvent>
							<Error reason="{ex.Message}"></Error>
						</Catch>
					</Try>
				</Action>
				<Action id="TryToAuthorizeFunds">
					<Script>
						newOrderId:= Evaluate('NewGuid()');
					</Script>
					<BuyEDaler to="{Seller}"
							   amount="{AmountToPay}"
							   currency="{Currency}"
							   reference="{'nfeat: ' + TokenId}"
							   contract="{TokenContract}"
							   serviceId="{ServiceProviderId}"
							   serviceProvider="{ServiceProviderType}">
						<Parameter key="AmountToPay" value="{AmountToPay}"></Parameter>
						<Parameter key="Currency" value="{Currency}"></Parameter>
						<Parameter key="OrderId" value="Not needed"></Parameter>
						<Parameter key="Country" value="{Country}"></Parameter>
						<Parameter key="Mode" value="Authorize"></Parameter>
						<Parameter key="PanAlias" value="{ActiveCardDetails.PanAlias}"></Parameter>
						<Parameter key="ExpiryDate" value="{ActiveCardDetails.ExpiryDate}"></Parameter>
						<Parameter key="MaskedPan" value="{ActiveCardDetails.MaskedPan}"></Parameter>
						<Parameter key="Brand" value="{ActiveCardDetails.CardBrand}" />
						<Parameter key="NewOrderId" value="{newOrderId}" />
						<Parameter key="TokenContract" value="{TokenContract}"></Parameter>
						<Parameter key="TokenId" value="{TokenId}"></Parameter>
						<Parameter key="Message" value="Authorization"></Parameter>
						<Parameter key="Buyer" value="{Buyer}"></Parameter>
						<Parameter key="BuyerEmail" value="{BuyerEmail}"></Parameter>
						<Parameter key="BuyerAddress" value="{BuyerAddress}"></Parameter>
						<Parameter key="BuyerCity" value="{BuyerCity}"></Parameter>
					</BuyEDaler>

					<CallAction actionRef="ConfirmPayment" beforeActionScript="SellEdalerOrderId:= newOrderId;" />				
				</Action>
				<Action id="RefundRegistrationAmount">
					<Try>
						<If condition="!exists(ActiveCardDetails.CardRegistrationDateTime)">
							<Then>
								<Script>
									ActiveCardDetails.RefundMessage:= "CardRegistration not performed. Nothing to refund.";
								</Script>
							</Then>
							<Else>
								<Script>
									AmountToSell:= ActiveCardDetails.RegistrationAmount;
									SellEdalerFrom:= Seller;
									AccountName:= SellerName;
									MessageOnError:= 'Regitration refund error';
									Mode:= 'Refund';
									Message:= "Povrat novca.";
									SellEdalerOrderId:= ActiveCardDetails.RegistrationOrderId;
									ActiveCardDetails.RefundMessage:= "";
								</Script>
								<CallAction actionRef="TrySellEdaler" />
							</Else>
						</If>
						<Catch exceptionVariable="ex">
							<Script>
								ActiveCardDetails.RefundMessage:= ex.Message;
							</Script>
						</Catch>
					</Try>
					<PersistVariable name="ActiveCardDetails" value="{ActiveCardDetails}" />
				</Action>
				<Action id="UpdateBuyerInformations">
					<Script>
						fullName:= SelectXmlStr(Note,'/default:UpdateBuyerInformations/@buyerFullName');
						city:= SelectXmlStr(Note,'/default:UpdateBuyerInformations/@city');
						phoneNumber:= SelectXmlStr(Note,'/default:UpdateBuyerInformations/@phoneNumber');
						email:= SelectXmlStr(Note,'/default:UpdateBuyerInformations/@email');
						address:= SelectXmlStr(Note,'/default:UpdateBuyerInformations/@address');
					</Script>
					<If condition="!Evaluate('System.String.IsNullOrWhiteSpace(fullName)')">
						<Then>
							<PersistVariable name="Buyer" value="{fullName}" />
						</Then>
					</If>
					<If condition="!Evaluate('System.String.IsNullOrWhiteSpace(phoneNumber)')">
						<Then>
							<PersistVariable name="BuyerPhoneNumber" value="{phoneNumber}" />
						</Then>
					</If>
					<If condition="!Evaluate('System.String.IsNullOrWhiteSpace(email)')">
						<Then>
							<PersistVariable name="BuyerEmail" value="{email}" />
						</Then>
					</If>
					<If condition="!Evaluate('System.String.IsNullOrWhiteSpace(address)')">
						<Then>
							<PersistVariable name="BuyerAddress" value="{address}" />
						</Then>
					</If>
					<If condition="!Evaluate('System.String.IsNullOrWhiteSpace(city)')">
						<Then>
							<PersistVariable name="BuyerCity" value="{city}" />
						</Then>
					</If>
				</Action>
				<Action id="IncrementFailedAttemptsCounter">
					<PersistVariable name="FailedPaymentAttempts" value="{Num(FailedPaymentAttempts) + 1}"></PersistVariable>
				</Action>
				<Action id="IncrementTotalCompletedPayments">
					<PersistVariable name="TotalCompletedPayments" value="{Num(TotalCompletedPayments) + 1}"></PersistVariable>
				</Action>
				<Action id="ResetFailedAttemptsCounter">
					<PersistVariable name="FailedPaymentAttempts" value="{Num(0)}"></PersistVariable>
				</Action>
				<Action id="CalculateNextAuthorizationRetryAttempt">
					<Script>
						nextDeliveryDate:= Evaluate('NowUtc.AddDays(1)');
					</Script>
					<PersistVariable name="DeliveryDate" value="{nextDeliveryDate}"></PersistVariable>
				</Action>
				<Action id="CalculateNextDeliveryDate">
					<Script>
						next:= Evaluate("NowUtc.AddMonths(1)");
						totalDaysInMonth:= Evaluate("System.DateTime.DaysInMonth(next.Year, next.Month)");
						nextDay:= DayOfMonth > totalDaysInMonth ? totalDaysInMonth : DayOfMonth;
						nextDeliveryDate:= Evaluate("DateTime(next.Year, next.Month, nextDay, 12, 0,0,0)");
					</Script>

					<PersistVariable name="DeliveryDate" value="{nextDeliveryDate}" />
				</Action>
				<Action id="SetBuyerTimeZoneDifference">
					<Script>
						offset:= Num(SelectXmlStr(Note,'/default:BuyerTimeZoneDifference/@timeZoneOffset'));
					</Script>
					<PersistVariable name="TimeZoneOffset" value="{offset}" />
				</Action>
				<Action id="SetServiceProvider">
					<If condition="!exists(serviceProviderId) or serviceProviderId == ''">
						<Then>
							<Script>
								config:= Evaluate("POWRS.Payment.PaySpot.ServiceConfiguration.GetCurrent()");
								isProduction:= config.IsProduction ?? false;
								serviceMode:= isProduction ? ".Live" : ".Test";

								serviceProviderId:= "POWRS.Payment.PaySpot.PayspotService" + serviceMode;
								serviceProviderType:= "POWRS.Payment.PaySpot.PayspotServiceProvider";
							</Script>
							<PersistVariable name="ServiceProviderId" value="{serviceProviderId}"/>
							<PersistVariable name="ServiceProviderType" value="{serviceProviderType}"/>
						</Then>
					</If>
				</Action>
				<Action id="MarkAsDone">
					<PersistVariable name="MarkedAsDone" value="true"/>
				</Action>
				<Action id="ConfirmPayment">
					<Script>
						<![CDATA[					
									AmountToSell:= AmountToPay;
									SellEdalerFrom:= Seller;
									AccountName:= SellerName;
									MessageOnError:= 'ReleaseFundsToSeller error';
									Mode:= 'Confirm';
									Message:= "";
								]]>
					</Script>
					<Try>
						<CallAction actionRef="TrySellEdaler" />
						<Catch exceptionVariable="ex">
							<PersistVariable name="ReleaseFundsToSellerError" value="{ex.Message}"/>
						</Catch>
					</Try>
				</Action>
				<Action id="TrySellEdaler">
					<Try>
						<LogEvent actor="{SellEdalerFrom}"
									eventId="TrySellEdaler"
									level="Medium"
									message="{'TrySellEdaler started - ' + ' Amount: ' + AmountToSell + ' Contract: ' + TokenContract + ' Currency: ' + Currency + ' From: ' + SellEdalerFrom + ' TokenId: ' + TokenId + ' ServiceProviderId: ' + ServiceProviderId + ' ServiceProviderType: ' + ServiceProviderType + ' AccountName: ' + AccountName }"
									module="SellEDaler"
									object=""
									type="Informational" />
						<SellEDaler amount="{AmountToSell}"
									contract="{TokenContract}"
									currency="{Currency}"
									from="{SellEdalerFrom}"
									reference="{Reference:='nfeat:'+TokenId}"
									serviceId="{ServiceProviderId}"
									serviceProvider="{ServiceProviderType}">
							<Parameter key="Amount" value="{AmountToSell}" />
							<Parameter key="Currency" value="{Currency}" />
							<Parameter key="AccountName" value="{AccountName}" />
							<Parameter key="ContractId" value="{TokenContract}" />
							<Parameter key="TokenId" value="{TokenId}" />
							<Parameter key="Message" value="{Message}" />
							<Parameter key="OrderId" value="{SellEdalerOrderId}" />
							<Parameter key="Mode" value="{Mode}" />
						</SellEDaler>
						<TextNote content="{'Amount of edaler: ' + AmountToSell + ' ' + Currency + ' sold. From: ' + SellEdalerFrom}" />
						<Catch exceptionVariable="ex">
							<LogEvent actor="{SellEdalerFrom}" eventId="SellEDaler" level="Medium" message="{MessageOnError + ' - ' + ex.Message }" module="SellEDaler" object="" type="Error" />
							<Error reason="{ex.Message}" />
						</Catch>
					</Try>
				</Action>
				<Action id="End">
					<End />
				</Action>

				<ReportPresent>
					| Variable | Value |
					|---------------------|-------------------------|
					| AmountToPay | {{AmountToPay}} |
					| Currency | {{Currency}} |
					| TokenContract | {{TokenContract}} |
					| Buyer | {{Buyer}} |
					| Seller | {{Seller}} |
				</ReportPresent>
			</StateMachine>
		</Definition>
		<Tag name="Seller">
			<RoleReference role="Creator" />
		</Tag>
		<Tag name="Buyer">
			<ParameterReference parameter="BuyerFullName" />
		</Tag>
		<Tag name="BuyerEmail">
			<ParameterReference parameter="BuyerEmail" />
		</Tag>
		<Tag name="BuyerAddress">
			<ParameterReference parameter="BuyerAddress" />
		</Tag>
		<Tag name="BuyerCity">
			<ParameterReference parameter="BuyerCity" />
		</Tag>
		<Tag name="CallBackUrl">
			<ParameterReference parameter="CallBackUrl" />
		</Tag>
		<Tag name="BuyerPhoneNumber">
			<ParameterReference parameter="BuyerPhoneNumber" />
		</Tag>
		<Tag name="Country">
			<ParameterReference parameter="Country" />
		</Tag>
		<Tag name="Title">
			<ParameterReference parameter="Title" />
		</Tag>
		<Tag name="Description">
			<ParameterReference parameter="Description" />
		</Tag>
		<Tag name="Value">
			<ParameterReference parameter="Value" />
		</Tag>
		<Tag name="Currency">
			<ParameterReference parameter="Currency" />
		</Tag>
		<Tag name="SellerName">
			<ParameterReference parameter="SellerName" />
		</Tag>
		<Tag name="SellerBankAccount">
			<ParameterReference parameter="SellerBankAccount" />
		</Tag>
		<Tag name="AmountToPay">
			<ParameterReference parameter="AmountToPay" />
		</Tag>
		<Tag name="PaymentDeadline">
			<ParameterReference parameter="PaymentDeadline" />
		</Tag>
		<Tag name="EscrowFee">
			<ParameterReference parameter="EscrowFee" />
		</Tag>
		<Tag name="RemoteId">
			<ParameterReference parameter="RemoteId" />
		</Tag>
		<Tag name="SuccessUrl">
			<ParameterReference parameter="SuccessUrl" />
		</Tag>
		<Tag name="ErrorUrl">
			<ParameterReference parameter="ErrorUrl" />
		</Tag>
		<Tag name="DeliveryDate">
			<ParameterReference parameter="DeliveryDate" />
		</Tag>
		<Tag name="TotalNumberOfPayments">
			<ParameterReference parameter="TotalNumberOfPayments" />
		</Tag>
		<Tag name="DayOfMonth">
			<ParameterReference parameter="DayOfMonth" />
		</Tag>
		<FriendlyName>
			<ParameterReference parameter="Title" />
		</FriendlyName>
		<Category>
			<String>Vaulter</String>
		</Category>
		<Description>
			<ParameterReference parameter="Description" />
		</Description>
		<Glyph contentType="image/png">
			iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAABHNCSVQICAgIfAhkiAAABFFJREFUeJztWU1IMlsYfrqTFmgLIb5yEURlLQo3YVZUCi1qFUFQUKt2QURWm7IgIkhqJ9IP1EIIWkWuIugPLIh0GVFUBC5SocCkEM2/uYvv3oPDNNM43Thwv3lgYM77d57zeI7nzEwBy7Is/mD8RZsAbSgC0CZAG4oAtAnQhiIAbQK0oQhAmwBtKALQJkAbigC0CdCGIgBtArShCECbAG0oAtAmQBuKALQJ0EahkCMYDGJpaQklJSV5F43H4+jr60NHRwfPNz8/j3g8jmw2i5qaGoyMjORdHwBSqRScTicODg5wfX2N19dXqNVqVFRUoLGxET09Pejv7/+6ECsAn8/HApB9LS4u8mo+PT3x4vJFJpNh29vbJfPY2dkRrSe4BL77uSCTyfBs4+PjPNvCwoLkmqenp2AYBufn55JzHh8fRf0FQh9G3t7ecHx8jOLiYo69tLQUZrOZtLe3t/Hr1y+k02liSyaTMBqNqKqq4nZWUAAA0Gg0iMVixC5FbK/XC6vVyrE1Nzdjbm4O3d3dYBiG2O/v77G7u4vZ2VlMT0/D4XAIF857Dv5mS65oNCopx+FwkBy73c5arVbS3t/fz6tPAOzt7a2kfgOBgHhdSVVEyITD4bxzYrEYe3R0RNoGg0E0d2BggJOfTCbl0P6cl6ykPAXIHWx1dfWndV5eXiT153K55FAWri0rKU8BGhoaSLzH4yF2u91O7ENDQ5/mer3eb+0aX+HHBYhGo6ID+GpwKysrxF9fXy+Hrih+/CRos9nI/dTUFM+fe1hyOp08fygUIvcGg0Fyv3V1dWhtbYXJZBIPlKMa8pgBubHpdJrn9/v9xM8wDM9vs9mIv7e3VxZHMfzoDFhdXSX3FouFs1f/C5PJBI1GA+D34eni4oLjLysrI/eBQOA/5yh4EBJN+udAAwDhcBjl5eWfxhUVFSGZTAIAlpeX0dbWhkQiwYnRarXY2trC5uYmAKCpqQk+n4/4Dw8P0dXVRdpS6eZyFM2RPKcEppfQEri8vJT9HPHx8SHY397eXt4cReOkDVm4uJAALS0tsgUYHR3l1LJYLHlvhVLjf2QJpNNpqFQq0na73UilUoJTkWEYPD8/Y2ZmhthyY6PRKHQ6HWmr1WrEYjEUFgo+zdNdAmNjY8RvNpsl19VqtSTP7XZzfGtra7yZMjg4yPr9fl4dj8dDdwnk+s/OziTXXV9fJ3k6nY7ndzqdspaU6Fgks8tNyikeDAY5PpfL9a2ja27uZ79uKBRia2trJQ++srJStD/hRSSCiYkJqFQqvL+/816ZJRIJTE5OIpvNcrYvqXC73bi6ukI2m8XDwwPvJKfX63F3d4dIJIKNjQ2cnJzg5uYGkUgEDMNAr9fDaDSis7MTw8PD5IwhBFl/gv8n/PFvhRUBaBOgDUUA2gRoQxGANgHaUASgTYA2FAFoE6ANRQDaBGhDEYA2AdpQBKBNgDYUAWgToA1FANoEaONve9o8PVvYS2AAAAAASUVORK5CYII=
		</Glyph>
	</Create>
	<role maxCount="1" minCount="1" name="Creator">
		<description xml:lang="en">
			<paragraph>
				<text>
					This is the role of the part that acts as the creator and owner of the token
					being created.
				</text>
			</paragraph>
		</description>
	</role>
	<role maxCount="1" minCount="1" name="TrustProvider">
		<description xml:lang="en">
			<paragraph>
				<text>
					This is the role of the trust provider that acts will host the token and
					approve its creation.
				</text>
			</paragraph>
		</description>
	</role>
	<parts>
		<templateOnly />
	</parts>
	<parameters>
		<stringParameter name="Title" value="" guide="Title" minLength="2">
			<description xml:lang="en">
				<paragraph>
					<text>Title of item.</text>
				</paragraph>
			</description>
		</stringParameter>
		<stringParameter name="Description" value="" guide="Description">
			<description xml:lang="en">
				<paragraph>
					<text>Description of item.</text>
				</paragraph>
			</description>
		</stringParameter>
		<numericalParameter name="Value" guide="Value of token" min="1" minIncluded="true">
			<description xml:lang="en">
				<paragraph>
					<text>The initial value of the token.</text>
				</paragraph>
			</description>
		</numericalParameter>
		<numericalParameter name="EscrowFee" value="0" guide="Vaulter Fees" min="0" minIncluded="true">
			<description xml:lang="en">
				<paragraph>
					<text>Vaulter transaction fees.</text>
				</paragraph>
			</description>
		</numericalParameter>

		<stringParameter name="Currency" value="RSD" guide="Currency" regEx="[A-Z]{3}" minLength="3" maxLength="3">
			<description xml:lang="en">
				<paragraph>
					<text>The initial currency of the token.</text>
				</paragraph>
			</description>
		</stringParameter>
		<stringParameter name="Country" value="RS" guide="Country" regEx="[A-Z]{2}" minLength="2" maxLength="2">
			<description xml:lang="en">
				<paragraph>
					<text>Country where token will be sold.</text>
				</paragraph>
			</description>
		</stringParameter>
		<numericalParameter name="CommissionPercent" value="0" guide="Commision (%)" min="0" minIncluded="true" max="100" maxIncluded="true">
			<description xml:lang="en">
				<paragraph>
					<text>The commission the Trust Provider gets for creating the tokens.</text>
				</paragraph>
			</description>
		</numericalParameter>
		<calcParameter name="Commission" guide="Commission" exp="Value*CommissionPercent/100">
			<description xml:lang="en">
				<paragraph>
					<text>Commission to be paid to the Trust Provider</text>
				</paragraph>
			</description>
		</calcParameter>
		<dateParameter name="Expires" guide="Expiry date" exp="Expires&gt;Now.Date">
			<description xml:lang="en">
				<paragraph>
					<text>When token expires.</text>
				</paragraph>
			</description>
		</dateParameter>
		<stringParameter name="SellerBankAccount" value="" guide="Seller's bank account number" minLength="8" maxLength="24">
			<description xml:lang="en">
				<paragraph>
					<text>Seller's bank account number</text>
				</paragraph>
			</description>
		</stringParameter>
		<stringParameter name="SellerName" value="">
			<description xml:lang="en">
				<paragraph>
					<text>Seller Name used to sellEdaler</text>
				</paragraph>
			</description>
		</stringParameter>
		<stringParameter name="BuyerFullName" value="" minLength="2">
			<description xml:lang="en">
				<paragraph>
					<text>First, Second and Last name of the buyer.</text>
				</paragraph>
			</description>
		</stringParameter>
		<stringParameter name="BuyerEmail">
			<description xml:lang="en">
				<paragraph>
					<text>Buyer Email.</text>
				</paragraph>
			</description>
		</stringParameter>
		<stringParameter name="BuyerAddress">
			<description xml:lang="en">
				<paragraph>
					<text>Billing Address of the buyer to be presented on the paylink and confirmation screen.</text>
				</paragraph>
			</description>
		</stringParameter>
		<stringParameter name="BuyerCity" value="">
			<description xml:lang="en">
				<paragraph>
					<text>City of billing Address of the buyer to be presented on the paylink and confirmation screen.</text>
				</paragraph>
			</description>
		</stringParameter>
		<dateTimeParameter name="PaymentDeadline">
			<description xml:lang="en">
				<paragraph>
					<text>Date and time untill buyer can pay.</text>
				</paragraph>
			</description>
		</dateTimeParameter>
		<calcParameter name="AmountToPay" exp="Value + EscrowFee">
			<description xml:lang="en">
				<paragraph>
					<text>Total amount to be paid, including fee.</text>
				</paragraph>
			</description>
		</calcParameter>
		<stringParameter name="RemoteId" value="">
			<description xml:lang="en">
				<paragraph>
					<text>Id from remote system.</text>
				</paragraph>
			</description>
		</stringParameter>
		<stringParameter name="CallBackUrl" value=" ">
			<description xml:lang="en">
				<paragraph>
					<text>Send info when transaction is completed.</text>
				</paragraph>
			</description>
		</stringParameter>
		<stringParameter name="BuyerPhoneNumber" value="">
			<description xml:lang="en">
				<paragraph>
					<text>Buyer phone number where to send notification.</text>
				</paragraph>
			</description>
		</stringParameter>
		<stringParameter name="SuccessUrl" value="">
			<description xml:lang="en">
				<paragraph>
					<text>Url to transfer when payment is completed.</text>
				</paragraph>
			</description>
		</stringParameter>
		<stringParameter name="ErrorUrl" value="">
			<description xml:lang="en">
				<paragraph>
					<text>Url to transfer when payment is not completed and has errors..</text>
				</paragraph>
			</description>
		</stringParameter>
		<dateTimeParameter name="DeliveryDate" exp="DeliveryDate &gt;= PaymentDeadline">
			<description xml:lang="en">
				<paragraph>
					<text>Date and time when funds card should be authorized.</text>
				</paragraph>
			</description>
		</dateTimeParameter>
		<numericalParameter name="TotalNumberOfPayments" value="1" min="1" minIncluded="true" max="36" maxIncluded="true">
			<description xml:lang="en">
				<paragraph>
					<text>Total number of montly payments.</text>
				</paragraph>
			</description>
		</numericalParameter>
		<numericalParameter name="DayOfMonth" value="1" min="1" minIncluded="true" max="31" maxIncluded="true">
			<description xml:lang="en">
				<paragraph>
					<text>Day of month, when card authorization will be initiated.</text>
				</paragraph>
			</description>
		</numericalParameter>
	</parameters>
	<humanReadableText xml:lang="en">
		<section>
			<header>
				<text>Create Vaulter Item token</text>
			</header>
			<body>
				<paragraph>
					<text>This contract creates a Neuro-Feature™ token representing an item for sale on a remote site using the Vaulter™ app.</text>
				</paragraph>
				<paragraph>
					<text>This contract creates a Neuro-Feature™ token representing an item for sale 						on a remote site using the Vaulter™ app.</text>
				</paragraph>
				<section>
					<header>
						<text>Information in token</text>
					</header>
					<body>
						<paragraph>
							<text>The token encodes the following information:</text>
						</paragraph>
						<bulletItems>
							<item>
								<text>A title to be displayed to viewers of the item: </text>
								<bold>
									<parameter name="Title" />
								</bold>
							</item>
							<item>
								<text>A textual description of the item to be displayed to viewers 								of the item: </text>
								<bold>
									<parameter name="Description" />
								</bold>
							</item>
							<item>
								<text>Bank account number: </text>
								<bold>
									<parameter name="SellerBankAccount" />
								</bold>
							</item>
						</bulletItems>
						<paragraph>
							<text>Additional information that is specified by the creator:</text>
						</paragraph>
						<bulletItems>
							<item>
								<text>Initial Value and Currency of the token: </text>
								<bold>
									<parameter name="Value" />
									<text>.</text>
									<parameter name="Currency" />
								</bold>
							</item>
							<item>
								<text>Token creation commission, payed by the creator to the Trust 								Provider: </text>
								<bold>
									<parameter name="CommissionPercent" />
									<text> %</text>
								</bold>
								<text>, corresponding to </text>
								<bold>
									<parameter name="Commission" />
									<text>.</text>
									<parameter name="Currency" />
								</bold>
								<text>.</text>
							</item>
							<item>
								<text>A date when the token expires: </text>
								<bold>
									<parameter name="Expires" />
								</bold>
								<text>.</text>
							</item>
						</bulletItems>
					</body>
				</section>
				<section>
					<header>
						<text>Ownership of token</text>
					</header>
					<body>
						<paragraph>
							<text>By signing this contract, the creator swears to be the owner of 								said item on the remote site. When the token is created, the owner 								becomes its first owner. The Creator is responsible for forwarding 								the responsabilities of the ownership of the token, unto the next 								owner, if transferred. The creator assures only to transfer the 								token to a new owner, as a sign that the ownership of the 								corresponding item on Limundo, has been sold to the corresponding 								buyer.</text>
						</paragraph>
					</body>
				</section>
				<section>
					<header>
						<text>Commission</text>
					</header>
					<body>
						<paragraph>
							<text>The token creation commission is paid by the Creator to the Trust 								Provider upon signature by both parties. Payment is done using 								eDaler®.</text>
						</paragraph>
					</body>
				</section>
				<section>
					<header>
						<text>Destruction of token</text>
					</header>
					<body>
						<paragraph>
							<text>The current owner of the token can destroy the token, when it 								chooses to. The destruction of the token will permit the creation of 								a new token with the same information. If not manually destroyed by 								the current owner of the token, the token expires at </text>
							<parameter name="Expires" />
							<text>. When the token expires, it is automatically destroyed. Records 								are only available for archiving purposes.</text>
						</paragraph>
					</body>
				</section>
				<section>
					<header>
						<text>Disclaimer</text>
					</header>
					<body>
						<paragraph>
							<text>This contract is an example on how a token creation contract may 								look like. For legal validity, a proper legal text must be provided.</text>
						</paragraph>
					</body>
				</section>
			</body>
		</section>
	</humanReadableText>
</contract>